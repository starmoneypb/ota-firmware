(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{6673:function(e,t,n){Promise.resolve().then(n.bind(n,9806))},9806:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return b}});var a=n(7437),s=n(2265);let r="https://api.github.com";async function c(e,t,n){let a=await fetch(e,{...t,headers:{Accept:"application/vnd.github+json","X-GitHub-Api-Version":"2022-11-28","Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0",...t.headers||{},...n?{Authorization:"Bearer ".concat(n)}:{}}});if(!a.ok){let e=await a.text().catch(()=>"");throw Error("GitHub API ".concat(a.status," ").concat(a.statusText," - ").concat(e))}return a.json()}async function l(e){let t=Date.now(),n="".concat(r,"/repos/").concat(e.owner,"/").concat(e.repo,"/contents/").concat(encodeURIComponent(e.otaDir),"?ref=").concat(encodeURIComponent(e.branch),"&_t=").concat(t),a=await c(n,{method:"GET"},e.token);return Array.isArray(a)?a.filter(e=>"file"===e.type&&e.name.endsWith(".bin")):[]}async function i(e,t,n,a,s){return c("".concat(r,"/repos/").concat(e.owner,"/").concat(e.repo,"/contents/").concat(encodeURIComponent(t)),{method:"PUT",body:JSON.stringify({message:a,branch:e.branch,content:n,...s?{sha:s}:{}})},e.token)}async function o(e,t,n,a){return c("".concat(r,"/repos/").concat(e.owner,"/").concat(e.repo,"/contents/").concat(encodeURIComponent(t)),{method:"DELETE",body:JSON.stringify({message:a,branch:e.branch,sha:n})},e.token)}async function d(e){if(e.size>104857600)throw Error("File too large (>100MB).");let[,t]=(await new Promise((t,n)=>{let a=new FileReader;a.onload=()=>t(String(a.result)),a.onerror=()=>n(a.error),a.readAsDataURL(e)})).split(",",2);return t||""}function u(e){let t=e instanceof Error?e.message:String(e);alert("Error: ".concat(t))}function m(e){let{className:t=""}=e;return(0,a.jsxs)("svg",{className:"animate-spin h-5 w-5 ".concat(t),viewBox:"0 0 24 24",children:[(0,a.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,a.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"})]})}let h={owner:"starmoneypb",repo:"ota-firmware",branch:"gh-pages",baseUrl:"https://starmoneypb.github.io/ota-firmware",otaDir:"ota-firmware",token:""};function x(e){let{onPublish:t}=e,[n,r]=function(){let[e,t]=(0,s.useState)(()=>{let e=window.localStorage.getItem("gh_settings");return e?{...h,...JSON.parse(e)}:h});return(0,s.useEffect)(()=>{window.localStorage.setItem("gh_settings",JSON.stringify(e))},[e]),[e,t]}(),[c,x]=(0,s.useState)([]),[p,g]=(0,s.useState)(!1),[f,b]=(0,s.useState)(""),[j,v]=(0,s.useState)(null),[N,w]=(0,s.useState)(!1),[y,S]=(0,s.useState)(null),k=(0,s.useMemo)(()=>!!n.token&&/^\d+\.\d+\.\d+$/.test(f.trim())&&(null==j?void 0:j.name.endsWith(".bin"))&&!N,[n.token,f,j,N]);async function C(){try{g(!0),x([]);let e=(await l(n)).map(e=>({name:e.name,version:function(e){let t=e.match(/^firmware_(\d+)_(\d+)_(\d+)\.bin$/);return t?"".concat(t[1],".").concat(t[2],".").concat(t[3]):null}(e.name),sha:e.sha,downloadUrl:e.download_url}));e.sort((e,t)=>{var n,a;return(null!==(n=t.version)&&void 0!==n?n:"").localeCompare(null!==(a=e.version)&&void 0!==a?a:"")}),x(e)}catch(e){u(e)}finally{g(!1)}}async function U(){if(k&&j)try{w(!0);let e=function(e){let t=e.trim().replace(/\./g,"_");return"firmware_".concat(t,".bin")}(f),t="".concat(n.otaDir,"/").concat(e),a=await d(j),s=c.find(t=>t.name===e);await i(n,t,a,s?"chore(ota): update ".concat(e):"feat(ota): add ".concat(e),null==s?void 0:s.sha),await new Promise(e=>setTimeout(e,1e3)),await C(),alert("Saved successfully.")}catch(e){u(e)}finally{w(!1)}}async function D(e){if(confirm("Delete ".concat(e.name,"?")))try{await o(n,"".concat(n.otaDir,"/").concat(e.name),e.sha,"chore(ota): delete ".concat(e.name)),await new Promise(e=>setTimeout(e,1e3)),await C()}catch(e){u(e)}}async function E(e){if(!e.version){alert("Invalid file name format, cannot derive version.");return}let a=function(e,t){let n=e.baseUrl.endsWith("/")?"":"/";return"".concat(e.baseUrl).concat(n).concat(e.otaDir,"/").concat(t)}(n,e.name);try{S(e.name),await t({firmware_url:a,version:e.version}),alert("Published.")}catch(e){u(e)}finally{S(null)}}return(0,s.useEffect)(()=>{C()},[n.owner,n.repo,n.branch,n.otaDir]),(0,a.jsxs)("div",{className:"grid gap-6",children:[(0,a.jsxs)("section",{className:"card",children:[(0,a.jsx)("h2",{className:"mb-3 text-lg font-semibold",children:"GitHub Pages Settings"}),(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"label",children:"Owner"}),(0,a.jsx)("input",{className:"input",value:n.owner,onChange:e=>r({...n,owner:e.target.value})})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"label",children:"Repo"}),(0,a.jsx)("input",{className:"input",value:n.repo,onChange:e=>r({...n,repo:e.target.value})})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"label",children:"Branch"}),(0,a.jsx)("input",{className:"input",value:n.branch,onChange:e=>r({...n,branch:e.target.value})})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"label",children:"Base URL"}),(0,a.jsx)("input",{className:"input",value:n.baseUrl,onChange:e=>r({...n,baseUrl:e.target.value})}),(0,a.jsx)("p",{className:"mt-1 text-xs text-gray-500",children:"ตัวอย่าง: https://starmoneypb.github.io"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"label",children:"OTA Folder"}),(0,a.jsx)("input",{className:"input",value:n.otaDir,onChange:e=>r({...n,otaDir:e.target.value})})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"label",children:"GitHub Fine-grained PAT (contents: read/write)"}),(0,a.jsx)("input",{type:"password",className:"input",value:n.token,onChange:e=>r({...n,token:e.target.value})}),(0,a.jsx)("p",{className:"mt-1 text-xs text-gray-500",children:"Token จะถูกเก็บใน localStorage ของเบราว์เซอร์คุณเท่านั้น"})]})]})]}),(0,a.jsxs)("section",{className:"card",children:[(0,a.jsx)("h2",{className:"mb-3 text-lg font-semibold",children:"Add / Update Firmware"}),(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 items-end",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"label",children:"Firmware (.bin)"}),(0,a.jsx)("input",{type:"file",accept:".bin,application/octet-stream",className:"input",onChange:e=>{var t,n;return v(null!==(n=null===(t=e.target.files)||void 0===t?void 0:t[0])&&void 0!==n?n:null)}})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"label",children:"Version (e.g. 1.0.1)"}),(0,a.jsx)("input",{className:"input",placeholder:"1.0.1",value:f,onChange:e=>b(e.target.value)})]}),(0,a.jsx)("div",{children:(0,a.jsx)("button",{className:"btn btn-primary w-full",disabled:!k,onClick:U,children:N?(0,a.jsxs)("span",{className:"inline-flex items-center gap-2",children:[(0,a.jsx)(m,{})," Saving..."]}):"Save"})})]}),(0,a.jsxs)("p",{className:"mt-2 text-xs text-gray-500",children:["ไฟล์จะถูกอัปโหลดไปที่"," ",(0,a.jsxs)("code",{children:[n.repo,"/",n.otaDir,"/firmware_<version with underscores>.bin"]})," ","บนสาขา ",(0,a.jsx)("code",{children:n.branch}),"."]})]}),(0,a.jsxs)("section",{className:"card",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-3",children:[(0,a.jsx)("h2",{className:"text-lg font-semibold",children:"Firmwares"}),(0,a.jsx)("button",{className:"btn btn-outline",onClick:C,disabled:p,children:p?(0,a.jsxs)("span",{className:"inline-flex items-center gap-2",children:[(0,a.jsx)(m,{})," Loading..."]}):"Refresh"})]}),(0,a.jsx)("div",{className:"overflow-x-auto",children:(0,a.jsxs)("table",{className:"min-w-full text-sm",children:[(0,a.jsx)("thead",{className:"text-left text-gray-600",children:(0,a.jsxs)("tr",{children:[(0,a.jsx)("th",{className:"py-2 pr-4",children:"File"}),(0,a.jsx)("th",{className:"py-2 pr-4",children:"Version"}),(0,a.jsx)("th",{className:"py-2 pr-4",children:"URL"}),(0,a.jsx)("th",{className:"py-2 pr-4 text-right",children:"Actions"})]})}),(0,a.jsxs)("tbody",{children:[c.map(e=>{var t;let s="".concat(n.baseUrl.replace(/\/$/,""),"/").concat(n.otaDir,"/").concat(e.name);return(0,a.jsxs)("tr",{className:"border-t",children:[(0,a.jsx)("td",{className:"py-2 pr-4 font-mono",children:e.name}),(0,a.jsx)("td",{className:"py-2 pr-4",children:null!==(t=e.version)&&void 0!==t?t:"-"}),(0,a.jsx)("td",{className:"py-2 pr-4",children:(0,a.jsx)("a",{className:"text-brand-600 underline",href:s,target:"_blank",rel:"noreferrer",children:s})}),(0,a.jsx)("td",{className:"py-2 pr-0 text-right",children:(0,a.jsxs)("div",{className:"flex justify-end gap-2",children:[(0,a.jsx)("button",{className:"btn btn-outline",onClick:()=>E(e),disabled:null!==y,children:y===e.name?(0,a.jsxs)("span",{className:"inline-flex items-center gap-2",children:[(0,a.jsx)(m,{})," Publishing..."]}):"Publish"}),(0,a.jsx)("button",{className:"btn btn-outline",onClick:()=>D(e),disabled:null!==y,children:"Delete"})]})})]},e.name)}),0===c.length&&!p&&(0,a.jsx)("tr",{children:(0,a.jsx)("td",{className:"py-4 text-gray-500",colSpan:4,children:"No firmware files."})})]})]})})]})]})}function p(e){let{status:t,lastError:n}=e,s="connected"===t?"bg-green-100 text-green-700":"connecting"===t?"bg-yellow-100 text-yellow-700":"error"===t?"bg-red-100 text-red-700":"bg-gray-100 text-gray-700";return(0,a.jsxs)("div",{className:"badge ".concat(s," inline-flex items-center gap-2"),children:["connecting"===t&&(0,a.jsx)(m,{className:"h-3 w-3"}),(0,a.jsxs)("span",{children:["MQTT: ",t]}),"error"===t&&n&&(0,a.jsx)("span",{title:n,children:"⚠"})]})}var g=n(8108);let f="device/ESP32-D15644";function b(){let{status:e,lastError:t,publish:n}=function(e){var t,n;let a=null!==(t=null==e?void 0:e.url)&&void 0!==t?t:"wss://test.mosquitto.org:8081",r=null!==(n=null==e?void 0:e.path)&&void 0!==n?n:"/mqtt",c=(0,s.useRef)(null),[l,i]=(0,s.useState)("idle"),[o,d]=(0,s.useState)(null);async function u(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=c.current;if(!a||"connected"!==l)throw Error("MQTT not connected");return new Promise((s,r)=>{let c="string"==typeof t?t:JSON.stringify(t);a.publish(e,c,{qos:n},e=>e?r(e):s())})}return(0,s.useEffect)(()=>{var t,n;let s=!0;i("connecting");let l="undefined"!=typeof crypto&&"randomUUID"in crypto?"web-".concat(crypto.randomUUID()):"web-".concat(Math.random().toString(16).slice(2),"-").concat(Date.now()),o=g.Z.connect(a,{protocol:"wss",path:r,clientId:null!==(t=null==e?void 0:e.clientId)&&void 0!==t?t:l,clean:!0,keepalive:null!==(n=null==e?void 0:e.keepalive)&&void 0!==n?n:60,reconnectPeriod:2e3,connectTimeout:3e4,protocolVersion:4});return c.current=o,o.on("connect",()=>s&&i("connected")),o.on("reconnect",()=>s&&i("connecting")),o.on("error",e=>{s&&(d(String((null==e?void 0:e.message)||e)),i("error"))}),o.on("close",()=>s&&i("error")),()=>{s=!1;try{o.end(!0)}catch(e){}}},[a,r]),{status:l,lastError:o,publish:u}}({url:"wss://test.mosquitto.org:8081",path:"/mqtt"}),[r,c]=(0,s.useState)(!1);async function l(t){if("connected"!==e)throw Error("MQTT not connected");c(!0),await n(f,{command:"UPDATE",payload:t},0),c(!1)}return(0,a.jsxs)("main",{className:"grid gap-6",children:[(0,a.jsxs)("section",{className:"card flex flex-wrap items-center justify-between gap-3",children:[(0,a.jsxs)("div",{className:"space-y-1",children:[(0,a.jsx)("h2",{className:"text-lg font-semibold",children:"Connection"}),(0,a.jsx)("p",{className:"text-xs text-gray-600",children:"Host: test.mosquitto.org (wss:8081, path: /mqtt)"})]}),(0,a.jsx)(p,{status:e,lastError:t})]}),(0,a.jsx)(x,{onPublish:l}),r&&(0,a.jsx)("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/20",children:(0,a.jsx)("div",{className:"card",children:(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsxs)("svg",{className:"animate-spin h-6 w-6",viewBox:"0 0 24 24",children:[(0,a.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,a.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"font-medium",children:"Publishing..."}),(0,a.jsxs)("p",{className:"text-xs text-gray-500",children:["กำลังส่งข้อความไปที่ ",(0,a.jsx)("code",{children:f})]})]})]})})})]})}}},function(e){e.O(0,[793,971,117,744],function(){return e(e.s=6673)}),_N_E=e.O()}]);